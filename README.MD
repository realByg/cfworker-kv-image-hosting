# ğŸ–¼ï¸ cfworker-kv-image-hosting

> Cloudflare workers KV å›¾åºŠ

## ğŸ“š åŸç†

[Cloudflare workers](https://developers.cloudflare.com/workers/) KV æ”¯æŒä½¿ç”¨ [`ReadableStream`](https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream) æ ¼å¼å­˜å‚¨æ•°æ®ï¼Œä½¿ç”¨ `FormData` å°†æ–‡ä»¶ä¼ è¾“åˆ° `workers` åï¼Œè°ƒç”¨ `Blob.stream()` æ–¹æ³•ï¼Œå¹¶å°†ä¸æ–‡ä»¶ç›¸å…³çš„å±æ€§å¦‚åç§°ã€å¤§å°ç­‰å­˜å…¥ `metadata`ï¼Œå°†è¿‡æœŸä¿¡æ¯å­˜å…¥ `expiration`ã€‚

```javascript
await KV_NAMESPACE.put(key, item.stream(), {
	expiration,
	metadata: {
		name: item.name,
		uploadedAt: new Date().getTime(),
		size: item.size
	}
})
```

> ä¸ºä»€ä¹ˆä¸è¦ä½¿ç”¨ `Base64`ï¼Ÿ

> å°†å›¾ç‰‡è½¬æ¢ä¸º `Base64` æ ¼å¼çš„ `dataURL` ä¹‹åï¼Œä¸ä»…ä½“ç§¯ä¼šå˜å¤§ï¼Œæ¯æ¬¡è·å–å›¾ç‰‡æ—¶è¿˜éœ€è¦å…ˆè½¬æ¢æˆ `Blob` åå†è¿”å›ï¼Œå¹¶ä¸”åœ¨ KV æ”¯æŒçš„ 3 ç§å­˜å‚¨æ ¼å¼ä¸­ï¼Œ`ReadableStream` è¯»å–æœ€å¿«ï¼Œ`text/json` æœ€æ…¢ã€‚

## ğŸƒ éƒ¨ç½²

> ç¯å¢ƒï¼šNodejs 14 +

1. å®‰è£… Cloudflare workers çš„ CLI å·¥å…· [wrangler](https://developers.cloudflare.com/workers/cli-wrangler/install-update) å¹¶ç™»å½•

    ```bash
    npm i @cloudflare/wrangler -g
    wrangler login
    ```

2. ä¸‹è½½æˆ– `git clone` ä»“åº“åˆ°æœ¬åœ°å¹¶å®‰è£…æ‰€éœ€ç¯å¢ƒ

    ```bash
    git clone https://github.com/realByg/cfworker-kv-image-hosting.git
    cd cfworker-kv-image-hostin/api
    npm i
    ```

3. é…ç½® `wrangler.toml` æ–‡ä»¶ï¼Œç²˜è´´åä¿®æ”¹ä¸‹æ–¹å¸¦ `#` éƒ¨åˆ†ï¼š

    ```toml
    name = '' # subdomain.workers.dev å‰ç¼€
    workers_dev = true
    type = 'webpack'
    webpack_config = 'webpack.config.js'
    compatibility_date = '2021-12-14'

    [vars]
    ENV = 'prod'
    USERNAME = '' # ç”¨æˆ·å
    PASSWORD = '' # å¯†ç 
    TTL = 3600 # cacheTtl ç¼“å­˜æ—¶é—´ (>60)
    DEDUPE = false # æ˜¯å¦å¼€å¯å»é‡ã€‚å¼€å¯åˆ™ä¼šä½¿ç”¨æ–‡ä»¶çš„ arraybuffer äº§ç”Ÿå”¯ä¸€ md5 å¹¶å–å‰ 8 ä½ä½œä¸º id è¦†ç›–åŸæ¥çš„å†…å®¹ï¼Œä¼šå¢åŠ  CPU æ¶ˆè€—ï¼›ä¸å¼€å¯åˆ™ä¼šä½¿ç”¨éšæœº 8 ä½å­—ç¬¦ä½œä¸º id

    [[kv_namespaces]]
    binding = 'ImageKV'
    id = '' # åœ¨ workers KV é¡µé¢åˆ›å»º KV åå°† id å¡«å…¥æ­¤

    [site]
    bucket = '../app/dist'
    entry-point = 'workers-site'
    ```

4. è¿è¡Œ `wrangler publish` å‘å¸ƒ `worker`

## ğŸ¥ é—®é¢˜

-   å…è´¹ç‰ˆ workers å¯¹ CPU çš„ä½¿ç”¨æ—¶é—´ã€KV çš„è¯»å–å’Œå­˜å‚¨æ¬¡æ•°å‡æœ‰é™åˆ¶
